#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

DEBVENDOR  := $(shell dpkg-vendor --query Vendor)
ifeq ($(DEBVENDOR), Qlustar)
    # Qlustar specific stuff
    include /usr/share/ql-deb-utils/Makefile
endif

# include defs of all DEB_HOST_*/DEB_BUILD_* vars
include /usr/share/dpkg/architecture.mk

PAMDIR=/lib/$(DEB_HOST_MULTIARCH)/security
MULTIARCHLIBDIR=/usr/lib/$(DEB_HOST_MULTIARCH)

export PERL_ARCHLIB := $(shell perl -MConfig -e \
  'print substr($$Config{vendorarch}, 1)')

%:
	dh $@ --with autoreconf

override_dh_auto_configure:
	# Don't enable crappy ucx interface before it's clear what versions
	# slurm supports
	dh_auto_configure -- --libdir=$(MULTIARCHLIBDIR) \
	  --sysconfdir=/etc/qlustar/common/slurm-llnl \
	  --localstatedir=/run/slurm --without-rpath \
	  --with-munge --with-pam_dir=$(PAMDIR) --enable-pam \
	  --with-pmix=$(MULTIARCHLIBDIR)/pmix --with-hwloc \
	  --enable-multiple-slurmd --disable-debug 

override_dh_auto_install:
	dh_auto_install

	# clear dependency_libs field in *.la files
	# see lintian non-empty-dependency_libs-in-la-file for reference
	sed -i "/dependency_libs/ s/'.*'/''/" $$(find debian/tmp/ -name '*.la')
	# Rename slurm(1) manpage before dh_installman run. It is not possible
	# to rename manpages in debian/*.manpages so hardcore `mv` is done here
	mv debian/tmp/usr/share/man/man1/slurm.1 \
	  debian/tmp/usr/share/man/man1/slurm-wlm.1

	# Handle pam stuff
	$(MAKE) -C contribs/pam install DESTDIR=$(CURDIR)/debian/tmp
	$(MAKE) -C contribs/pam_slurm_adopt install DESTDIR=$(CURDIR)/debian/tmp

	# Handle pmi/pmi2 stuff
	$(MAKE) -C contribs/pmi install DESTDIR=$(CURDIR)/debian/tmp
	$(MAKE) -C contribs/pmi2 install DESTDIR=$(CURDIR)/debian/tmp

	# Handle libslurm[db]-perl pkgs
	$(MAKE) -C contribs/perlapi install DESTDIR=$(CURDIR)/debian/tmp \
	  PERL_MM_OPT="INSTALLDIRS=vendor"
	find debian/tmp/$(PERL_ARCHLIB) -type f -name "*.so" | xargs chrpath -d

	# Handle slurm-wlm-torque
	$(MAKE) -C contribs/torque \
	  install DESTDIR=$(CURDIR)/debian/tmp
	# build manpages for torque wrappers
	for i in debian/tmp/usr/bin/pbsnodes debian/tmp/usr/bin/q*; do \
	  pod2man $$i > debian/tmp/usr/share/man/man1/$$(basename $$i).1; \
	done

	# Qlustar gethostname for HA purposes
	mkdir -p debian/tmp/usr/lib/$(DEB_HOST_MULTIARCH)/slurm
	gcc -fPIC -shared -o \
	  debian/tmp/usr/lib/$(DEB_HOST_MULTIARCH)/slurm/gethostname.so \
	  debian/gethostname.c

	# Remove embedded jquery.min.js
	rm -f debian/tmp/usr/share/doc/slurm-wlm-doc/html/jquery.min.js

override_dh_strip:
	dh_strip -plibslurm35
	dh_strip -plibpmi0
	dh_strip -plibpmi2-0
	dh_strip -pslurm-wlm-basic-plugins
	dh_strip -pslurm-client
	dh_strip -pslurmd
	dh_strip -pslurmctld
	dh_strip -pslurmdbd
	# we do not care about debug symbols for those pkgs
	dh_strip -plibslurmdb-perl --no-automatic-dbgsym
	dh_strip -plibslurm-perl --no-automatic-dbgsym
	dh_strip -psview --no-automatic-dbgsym
	dh_strip -plibpam-slurm --no-automatic-dbgsym
	dh_strip -plibpmi0-dev --no-automatic-dbgsym
	dh_strip -plibpmi2-0-dev --no-automatic-dbgsym
	dh_strip -plibslurm-dev --no-automatic-dbgsym
	dh_strip -pslurm-wlm-basic-plugins-dev --no-automatic-dbgsym
	strip --strip-debug --remove-section=.comment \
		--remove-section=.note debian/slurm-wlm-basic-plugins-dev/usr/lib/*/slurm/*.a

override_dh_auto_test:

override_dh_compress:
	dh_compress -X.pdf -X.ttf
