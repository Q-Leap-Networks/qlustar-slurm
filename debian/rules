#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

DEBVENDOR  := $(shell dpkg-vendor --query Vendor)

ifeq ($(DEBVENDOR), Qlustar)
    # Qlustar specific stuff
    include /usr/share/ql-deb-utils/Makefile
endif

# include defs of all DEB_HOST_*/DEB_BUILD_* vars
include /usr/share/dpkg/architecture.mk

PAMDIR=/lib/$(DEB_HOST_MULTIARCH)/security

export PERL_ARCHLIB := $(shell perl -MConfig -e \
  'print substr($$Config{vendorarch}, 1)')

%:
	dh $@ --parallel --with autoreconf

override_dh_autoreconf:
	dh_autoreconf -- sh -c ./autogen.sh

override_dh_auto_configure:
	dh_auto_configure -- --libdir=\$${prefix}/lib/$(DEB_HOST_MULTIARCH) \
	  --sysconfdir=/etc/qlustar/common/slurm-llnl \
	  --localstatedir=/var/run/slurm-llnl --without-rpath \
	  --with-munge --with-pam_dir=$(PAMDIR) --enable-pam

override_dh_auto_install:
	dh_auto_install

	# clear dependency_libs field in *.la files
	# see lintian non-empty-dependency_libs-in-la-file for reference
	sed -i "/dependency_libs/ s/'.*'/''/" $$(find debian/tmp/ -name '*.la')
	# Rename slurm(1) manpage before dh_installman run. It is not possible
	# to rename manpages in debian/*.manpages so hardcore `mv` is done here
	mv debian/tmp/usr/share/man/man1/slurm.1 \
	  debian/tmp/usr/share/man/man1/slurm-wlm.1

	# Handle pam stuff
	$(MAKE) -C contribs/pam install DESTDIR=$(CURDIR)/debian/tmp

	# Handle pmi2 stuff
	$(MAKE) -C contribs/pmi2 install DESTDIR=$(CURDIR)/debian/tmp

	# Handle libslurm[db]-perl pkgs
	$(MAKE) -C contribs/perlapi install DESTDIR=$(CURDIR)/debian/tmp \
	  PERL_MM_OPT="INSTALLDIRS=vendor"
	find debian/tmp/$(PERL_ARCHLIB) -type f -name "*.so" | xargs chrpath -d

	# Handle slurm-wlm-torque
	$(MAKE) -C contribs/torque \
	  install DESTDIR=$(CURDIR)/debian/tmp
	# build manpages for torque wrappers
	for i in debian/tmp/usr/bin/pbsnodes debian/tmp/usr/bin/q*; do \
	  pod2man $$i > debian/tmp/usr/share/man/man1/$$(basename $$i).1; \
	done

	# Qlustar gethostname for HA purposes
	mkdir -p debian/tmp/usr/lib/$(DEB_HOST_MULTIARCH)/slurm
	gcc -fPIC -shared -o \
	  debian/tmp/usr/lib/$(DEB_HOST_MULTIARCH)/slurm/gethostname.so \
	  debian/gethostname.c

override_dh_install:
	dh_install --list-missing

override_dh_installinit:
	dh_installinit --package=slurmdbd --update-rcd-params="defaults 98 02"
	dh_installinit --package=slurmctld --update-rcd-params="defaults 99 01"
	dh_installinit --package=slurmd --update-rcd-params="defaults 99 01"


override_dh_auto_test:
